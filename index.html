<!DOCTYPE html>
<html>
	<head>
		<title>Hi Fieny!</title>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
		<!-- jQuery -->
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="jquery-ui.min.js"></script> -->
        <script src="jquery.min.js"></script>
        <script src="jquery-ui.min.js"></script>
		<link rel="stylesheet" href="styles.css"/>
	</head>
	<body>
        <div class="grid">
            <div class="con container1" id="1">
                <div class="cell img4"></div>
            </div>
            <div class="con container2" id="2">
                <div class="cell img9"></div>
            </div>
            <div class="con container3" id="3">
                <div class="cell img1"></div>
            </div>
            <div class="con container4" id="4">
                <div class="cell img6"></div>
            </div>
            <div class="con container5" id="5">
                <div class="cell img7"></div>
            </div>
            <div class="con container6" id="6">
                <div class="cell img2"></div>
            </div>
            <div class="con container7" id="7">
                <div class="cell img8"></div>
            </div>
            <div class="con container8" id="8">
                <div class="cell img5"></div>
            </div>
            <div class="con container9" id="9">
                <div class="cell img3"></div>
            </div>
        </div>

        <script>
            // settings
            var cellSize = 100;
            var cellGap = 10;
            var marginTop = 10;
            var marginLeft = 10;
            var snapRange = 70;

            var lastCell = null;
            var lastCellOriginalOffset = null;
            var movedCellOffset = null;
            var collidingCell = null;
            
            var t = 0;
            var b = 0;
            var l = 0;
            var r = 0;

            var secondRow = marginTop + cellSize + cellGap + snapRange;
            var thirdRow = marginTop + 2*(cellSize + cellGap) + snapRange;

            var secondCol = marginLeft + cellSize + cellGap + snapRange;
            var thirdCol = marginLeft + 2*(cellSize + cellGap) + snapRange;

            var isSnap = false;

            var initialPos = 0;
            var position = 0;

            function snapTo(cellPos) {
                var posClass = '.container'+cellPos;
                var removed = $('.container'+cellPos).children().detach();
                $(".container"+initialPos).prepend(removed);
                isSnap = false;
            }

            function snapToCurrent(cell) {
                var removed = cell.detach();
                $(".container"+position).prepend(removed);
                isSnap = false;
                position = 0;
            }

            // 150*150
            $.fn.draggableXY = function(options) {
                var defaultOptions = {
                    distance: 5,
                    dynamic: false
                };
                options = $.extend(defaultOptions, options);
                
                this.draggable({
                    distance: options.distance,
                    start: function (event, ui) {
                        lastCellOriginalOffset = $(this).offset();
                        ui.helper.data('draggableXY.originalPosition', ui.position || {top: 0, left: 0});
                        ui.helper.data('draggableXY.newDrag', true);
                        t = lastCellOriginalOffset.top - snapRange;
                        b = lastCellOriginalOffset.top + snapRange;
                        l = lastCellOriginalOffset.left - snapRange;
                        r = lastCellOriginalOffset.left + snapRange;
                        isSnap = true;
                    },
                    drag: function (event, ui) {
                        var originalPosition = ui.helper.data('draggableXY.originalPosition');
                        var deltaX = Math.abs(originalPosition.left - ui.position.left);
                        var deltaY = Math.abs(originalPosition.top - ui.position.top);

                        var newDrag = options.dynamic || ui.helper.data('draggableXY.newDrag');
                        ui.helper.data('draggableXY.newDrag', false);

                        var xMax = newDrag ? Math.max(deltaX, deltaY) === deltaX : ui.helper.data('draggableXY.xMax');
                        ui.helper.data('draggableXY.xMax', xMax);

                        var newPosition = ui.position;
                        if(xMax) {
                            newPosition.top = originalPosition.top;
                        }
                        if(!xMax){
                            newPosition.left = originalPosition.left;
                        }

                        if (isSnap) {
                            if (ui.offset.top < t) {
                                position = findPosition(t, lastCellOriginalOffset.left + cellSize/2);
                                snapTo(position);
                            }

                            if (ui.offset.top > b) {
                                position = findPosition(b, lastCellOriginalOffset.left + cellSize/2);
                                snapTo(position);
                            }

                            if (ui.offset.left < l) {
                                position = findPosition(lastCellOriginalOffset.top + cellSize/2, l);
                                snapTo(position);
                            }

                            if (ui.offset.left > r) {
                                position = findPosition(lastCellOriginalOffset.top + cellSize/2, r);
                                snapTo(position);
                            }
                        }

                        return newPosition;
                    }
                });
            };
            
            $('.grid .cell').draggableXY();
            $('.grid .cell').mousedown(function() {
                $(this).css('z-index', 10);
                lastCell = $(this);
                initialPos = lastCell.parent().attr('id');
                alert('click');
            });

            $('.grid .cell').mouseup(function() {
                lastCell.css({'z-index': 0, top: 0, left: 0});
                if (position !== 0) {
                    snapToCurrent(lastCell);
                }
                $('.grid .cell').off('draggableXY');
                $('.grid .cell').draggableXY();
                checkTheTruth();
            });

            function findPosition(x, y) {
                var row = 0;
                var col = 0;

                if (x >= marginTop && x < snapRange) {
                    row = 0;
                } else if (x >= snapRange && x < secondRow) {
                    row = 1;
                } else if (x >= secondRow && x < thirdRow) {
                    row = 2;
                }

                if (y >= marginLeft && y < snapRange) {
                    col = 1;
                } else if (y >= snapRange && y < secondCol) {
                    col = 2;
                } else if (y >= secondCol && y < thirdCol) {
                    col = 3;
                }

                return (row*3 + col);
            }

            function checkTheTruth() {

            }
        </script>
	</body>
</html>
